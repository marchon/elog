#!/usr/bin/env coffee
elog = require(__dirname + '/../lib/elog.coffee').elog

unless process.argv[2]
  console.log "Usage: elog-server /path/to/server/config.json"
  console.log "       elog-server reload # reload configuration"
  console.log "       elog-server stop # stop the current running process"
  process.exit 1

elog.reload('elog-server') if process.argv[2] == 'reload'
elog.stop('elog-server') if process.argv[2] == 'stop'

configFile = process.argv[2]

# run server
server = null

start = () ->
  console.log "Starting elog-server."
  server = new elog.server(require(configFile, true), elog.db)
  server.run()

reload = () ->
  server.shutdown()
  server = null
  delete require.cache[configFile]
  start()

process.on 'SIGHUP', () ->
  console.log "Reloading elog-server."
  reload()

start()
