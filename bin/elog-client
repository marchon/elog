#!/usr/bin/env coffee
elog = require(__dirname + '/../lib/elog.coffee').elog
fs = require 'fs'
os = require 'os'

TMP_POSITION_FILE = "elog.positions.json"
positionFile = os.tmpDir() + "/#{TMP_POSITION_FILE}"

unless process.argv[2]
  console.log "usage: elog-client /path/to/your/client.json"
  console.log "       elog-client reset-positions # reset all positions of logs"
  console.log "       elog-client reload # reload configuration"
  process.exit 1

if process.argv[2] == 'reset-positions'
  fs.unlinkSync positionFile
  process.exit 0

elog.reload('elog-client') if process.argv[2] == 'reload' 

configFile = process.argv[2]

# load positions of apps
unless fs.existsSync positionFile
  fs.writeFileSync positionFile, "{}"
  positionData = {}
else
  positionData = require positionFile

# run mclient
mclient = null

start = () ->
  # load configuration
  mclient = new elog.mclient(require(configFile), elog, positionFile, positionData)
  mclient.run()

reload = () ->
  mclient.shutdown()
  mclient = null
  delete require.cache[configFile]
  start()

process.on 'SIGHUP', () ->
  console.log "Reloading elog-client ..."
  reload()

start()
